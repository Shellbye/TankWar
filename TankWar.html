<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="author" content="shellbye">
    <meta name="co-author" content="baybaylee">
    <title>Tank War</title>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        .column {
            width: 5px;
            height: 5px;
            border-left: 1px solid #000;
            border-top: 1px solid #000;
            display: inline-block;
        }

        .last_col {
            border-right: 1px solid #000;
        }

        .row {
            margin-top: -12px;
            padding-left: 10px;
        }

        .last_row {
            border-bottom: 1px solid #000;;
        }

        #zone {
            padding-top: 10px;
            float: left;
        }

        #control {
            margin-left: 5px;
            margin-top: 7px;
            float: left;
            border: 1px solid #000;
            height: 367px;
            padding: 20px 10px 20px 10px;
            width: 184px;

            /*display: none;*/
        }
    </style>
</head>
<body onkeydown="keyDown()">
<div id="zone">

</div>
<div id="control">
    <label for="speed">
        Current Speed:<input id="speed" value="" readonly>
    </label>
    <br>
    <label for="score">
        Current Score:<input id="score" value="" readonly>
    </label>
    <br>
    <label for="time">
        Time You used:<input id="time" value="" readonly>
    </label>
    <p>Press P or Space to Start/Pause</p><br>
    <p>You can use both</p>
    <p style="margin-left: 50px">↑↓←→</p>
    <P>to control direction</P><br>
    <p>Use Q or Enter to fire</p>
    <br>
    <!--<button id="reTry" onclick="init()">reTry</button>-->
    <br>
    <p>By
        <a href="http://baybaylee.github.io/" target="_blank">BaybayLee</a> &
        <a href="http://shellbye.com" target="_blank">Shellbye</a>
    </p>
    <p>Source code is
        <a href="https://github.com/Shellbye/TankWar" target="_blank">here</a>,
        and demo is <a href="http://shellbye.com/TankWar/" target="_blank">here</a>
    </p>
</div>
</body>
<script>
    // left=37, up=38, right=39, down=40
    /*
     *   Tank:
     *    |0|
     *  |1|2|3|
     *  |4|5|6|
     *  |7|8|9|
     *
     *  one hour of 2015-05-19
     *
     * */

    const U = 38;
    const D = 40;
    const L = 37;
    const R = 39;
    var width = 90;
    var height = 60;
    var isOver = false;
    var stopped = 0;
    var score = 0;
    var myTank;
    var bullets = [];
    var bulletsInterval = 0;
    var tanks = [];
    var tanksInterval = 0;
    var enemyTankOnSight = 10;
    var bulletColor = "grey";
    var myTankColor = "red";
    var enemyColor  = "black";
    window.onload = function () {
        init();
    };

    function init() {
        console.log("start");
        initMap(width, height);
        initTank(28, 20);
        document.getElementById("score").value = score;
        generateOtherTank();
        setAllInterval();
    }

    function clearAllInterval(){
        clearInterval(myTank.autoMove);
        clearInterval(bulletsInterval);
        clearInterval(tanksInterval);
        for(var i=0; i<tanks.length; i++){
            clearInterval(tanks[i].autoMove);
        }
    }

    function setAllInterval(){
        for(var i=0; i<tanks.length; i++){
            tanks[i].autoMove = setInterval("tanks[tanks.length-1].tMove()", 50);
        }
        myTank.autoMove = setInterval("myTank.tMove()", 50);
        bulletsInterval = setInterval("moveAllBullets()", 10);
        tanksInterval = setInterval("changeTanksDirection()", 2000);
    }

    function changeTanksDirection(){
        for(var i=0; i<tanks.length; i++){
            var t = tanks[i];
            var tx = parseInt(t.bodys[5].getAttribute("x"));
            var ty = parseInt(t.bodys[5].getAttribute("y"));
            var mx = parseInt(myTank.bodys[5].getAttribute("x"));
            var my = parseInt(myTank.bodys[5].getAttribute("y"));
            var xd = tx - mx;
            var yd = ty - my;
            if(Math.abs(xd) > Math.abs(yd)){
                // the tank is far away from myTank in x direction
                t.changeDirection(xd > 0 ? L : R);
            }else{
                t.changeDirection(yd > 0 ? D : U);
            }
        }
    }

    function generateOtherTank(){
        if(tanks.length >= enemyTankOnSight){
            return;
        }else{
            var tank = new Tank(2, height - 1, D, enemyColor);
            tanks.push(tank);
        }
    }

    function moveAllBullets(){
        var len = bullets.length;
        for(var i=0; i<len; i++){
            bullets[i].bMove();
        }
    }

    function isParameterValid(x, y, direction) {
        if (x < 1 || x > width || y < 1 || y > height) {
            return false;
        }
    }

    function Tank(x, y, direction, background) {
        if (isParameterValid(x, y, direction)) {
            console.log("illegal parameter");
            return;
        }

        // init body and direction
        this.direction = direction;
        this.autoMove = 0;
        this.background = background;
        this.bodys = new Array(10);
        this.bodys[1] = document.querySelector('[x="' + (x - 1).toString() + '"][y="' + (y + 1).toString() + '"]');
        this.bodys[2] = document.querySelector('[x="' + x.toString() + '"][y="' + (y + 1).toString() + '"]');
        this.bodys[3] = document.querySelector('[x="' + (x + 1).toString() + '"][y="' + (y + 1).toString() + '"]');
        this.bodys[4] = document.querySelector('[x="' + (x - 1).toString() + '"][y="' + y.toString() + '"]');
        this.bodys[5] = document.querySelector('[x="' + x.toString() + '"][y="' + y.toString() + '"]');
        this.bodys[6] = document.querySelector('[x="' + (x + 1).toString() + '"][y="' + y.toString() + '"]');
        this.bodys[7] = document.querySelector('[x="' + (x - 1).toString() + '"][y="' + (y - 1).toString() + '"]');
        this.bodys[8] = document.querySelector('[x="' + x.toString() + '"][y="' + (y - 1).toString() + '"]');
        this.bodys[9] = document.querySelector('[x="' + (x + 1).toString() + '"][y="' + (y - 1).toString() + '"]');
        if (direction == U) {
            this.bodys[0] = document.querySelector('[x="' + x.toString() + '"][y="' + (y + 2).toString() + '"]');
        } else {
            this.bodys[0] = document.querySelector('[x="' + x.toString() + '"][y="' + (y - 2).toString() + '"]');
        }
        for (var i = 0; i < 10; i++) {
            this.bodys[i].style.background = this.background;
        }

        this.tMove = function () {
            for (var j = 0; j < 10; j++) {
                var oldX = parseInt(this.bodys[j].getAttribute("x"));
                var oldY = parseInt(this.bodys[j].getAttribute("y"));
                if (this.direction == U) {
                    if (oldY == height) break;
                    if (j == 7 || j == 8 || j == 9) this.bodys[j].style.background = "";
                    this.bodys[j] = document.querySelector('[x="' + (oldX).toString() + '"][y="' + (oldY + 1).toString() + '"]');
                } else if (this.direction == D) {
                    if (oldY == 1) break;
                    if (j == 1 || j == 2 || j == 3) this.bodys[j].style.background = "";
                    this.bodys[j] = document.querySelector('[x="' + (oldX).toString() + '"][y="' + (oldY - 1).toString() + '"]');
                } else if (this.direction == L) {
                    if (oldX == 1) break;
                    if (j == 3 || j == 6 || j == 9) this.bodys[j].style.background = "";
                    this.bodys[j] = document.querySelector('[x="' + (oldX - 1).toString() + '"][y="' + (oldY).toString() + '"]');
                } else if (this.direction == R) {
                    if (oldX == width) break;
                    if (j == 1 || j == 4 || j == 7) this.bodys[j].style.background = "";
                    this.bodys[j] = document.querySelector('[x="' + (oldX + 1).toString() + '"][y="' + (oldY).toString() + '"]');
                }
                this.bodys[j].style.background = this.background;
            }
        };

        this.changeDirection = function (d) {
            if (d == this.direction) {
                return;
            }
            var x = parseInt(this.bodys[5].getAttribute("x"));
            var y = parseInt(this.bodys[5].getAttribute("y"));
            this.bodys[0].style.background = "";
            if (d == U) {
                this.bodys[0] = document.querySelector('[x="' + x.toString() + '"][y="' + (y + 2).toString() + '"]');
            } else if (d == D) {
                this.bodys[0] = document.querySelector('[x="' + x.toString() + '"][y="' + (y - 2).toString() + '"]');
            } else if (d == L) {
                this.bodys[0] = document.querySelector('[x="' + (x - 2).toString() + '"][y="' + (y).toString() + '"]');
            } else if (d == R) {
                this.bodys[0] = document.querySelector('[x="' + (x + 2).toString() + '"][y="' + (y).toString() + '"]');
            }
            this.bodys[0].style.background = this.background;
            this.direction = d;
        };

        this.shoot = function(){
            var x = parseInt(this.bodys[0].getAttribute("x"));
            var y = parseInt(this.bodys[0].getAttribute("y"));
            var bullet;
            if (this.direction == U) {
                bullet = new Bullet(x, y+1, this.direction, bulletColor);
            } else if (this.direction == D) {
                bullet = new Bullet(x, y-1, this.direction, bulletColor);
            } else if (this.direction == L) {
                bullet = new Bullet(x-1, y, this.direction, bulletColor);
            } else {
                bullet = new Bullet(x+1, y, this.direction, bulletColor);
            }
            bullets.push(bullet);
        }
    }

    function Bullet(x,y,direction, bulletColor){
        this.direction = direction;
        this.autoMove = 0;
        this.body = document.querySelector('[x="' + x.toString() + '"][y="' + y.toString() + '"]');
        this.body.style.background = bulletColor;
        this.body.setAttribute("isBullet", "1");
        this.bMove = function(){
            var oldX = parseInt(this.body.getAttribute("x"));
            var oldY = parseInt(this.body.getAttribute("y"));
            if(oldX == 1 || oldX == width || oldY == 1 || oldY == height){
                this.body.style.background = "";
                clearInterval(this.autoMove);
                bullets.splice(bullets.indexOf(this),1);
                return
            }
            this.body.style.background = "";
            if (this.direction == U) {
                this.body = document.querySelector('[x="' + oldX.toString() + '"][y="' + (oldY + 1).toString() + '"]');
            } else if (this.direction == D) {
                this.body = document.querySelector('[x="' + oldX.toString() + '"][y="' + (oldY - 1).toString() + '"]');
            } else if (this.direction == L) {
                this.body = document.querySelector('[x="' + (oldX - 1).toString() + '"][y="' + (oldY).toString() + '"]');
            } else if (this.direction == R) {
                this.body = document.querySelector('[x="' + (oldX + 1).toString() + '"][y="' + (oldY).toString() + '"]');
            }

            this.body.style.background = bulletColor;
        }
    }

    function keyDown() {
        var event = arguments.callee.caller.arguments[0] || event;
        var code = event.which;
        if(isOver){
            return;
        }
        if (code >= 37 && code <= 40) {
            myTank.changeDirection(code);
        }else if(code == 80 || code == 32){
            // 'P'=80, 'Space'=32
            if(stopped == 0){
                clearAllInterval();
                stopped = 1;
            }else if(stopped == 1){
                setAllInterval();
                stopped = 0;
            }
        }else if(code == 81 || code == 13){
            // 'Q'=13, 'Enter'=13
            myTank.shoot();
        }
    }

    function initTank(x, y) {
        myTank = new Tank(x, y, U, myTankColor);
    }

    function initMap() {
        var zone = document.getElementById("zone");
        zone.innerHTML = "";
        for (var i = height; i >= 1; i--) {
            var row = document.createElement("div");
            row.setAttribute("class", "row");
            initRow(row, i.toString());
            zone.appendChild(row);
        }
    }

    function initRow(map, y) {
        for (var i = 1; i <= width; i++) {
            var common = document.createElement("div");
            var className = "column";
            if (i == width) {
                className += " last_col";
            }
            if (y == 1) {
                className += " last_row";
            }
            common.setAttribute("class", className);
            common.setAttribute("x", i.toString());
            common.setAttribute("y", y);
            map.appendChild(common);
        }
    }

</script>
</html>
